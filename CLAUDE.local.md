# moai-adk-go Local Development Guide

> **Purpose**: Essential guide for local moai-adk-go development
> **Audience**: GOOS (local developer only)
> **Last Updated**: 2026-02-06

---

## 1. Quick Start

### Work Location
```bash
# Primary work location (template development)
/Users/goos/MoAI/moai-adk-go/internal/template/templates/

# Local project (testing & git)
/Users/goos/MoAI/moai-adk-go/
```

### Development Cycle
```
1. Work in internal/template/templates/
2. Run `make build` to regenerate embedded files
3. Test in local project
4. Git commit from local root
```

---

## 2. File Synchronization

### Protected Directories (Never Modify During Template Sync)
```bash
# CRITICAL: These directories contain user data and must NEVER be deleted
.claude/        # Local Claude Code configuration
.moai/project/  # Project documentation (product.md, structure.md, tech.md)
.moai/specs/    # SPEC documents (active development files)
```

### Template Source (Single Source of Truth)
```bash
# All template changes MUST be made here
internal/template/templates/.claude/
internal/template/templates/.moai/
internal/template/templates/CLAUDE.md
```

### Local-Only Files (Never in Templates)
```
.claude/settings.local.json    # Personal settings
CLAUDE.local.md                # This file
.claude/hooks/moai/handle-*.sh  # Generated hook wrappers (not templates)
.moai/cache/                   # Cache
.moai/logs/                    # Logs
.moai/memory/                  # Memory storage
```

### Embedded Template System

moai-adk-go uses Go's `go:embed` directive to bundle templates:

**Source Location**:
- `internal/template/templates/` - Edit here

**Embedded Files** (Auto-generated, DO NOT EDIT):
- `internal/template/embedded.go` - Auto-generated by `go generate`

**Build Process**:
```bash
# After editing templates, regenerate embedded files
make build

# Or manually
go generate ./internal/template/...
```

---

## 3. Code Standards

### Language: English Only

**Source Code (Go):**
- All code, comments, godoc in English
- Package names: lowercase, single word
- Exported names: PascalCase
- Private names: camelCase
- Constants: PascalCase or UPPER_SNAKE_CASE
- Commit messages: English (Conventional Commits)

**Configuration Files (English ONLY):**
- Command files (.claude/commands/**/*.md): English only
- Agent definitions (.claude/agents/**/*.md): English only
- Skill definitions (.claude/skills/**/*.md): English only
- Hook scripts (.claude/hooks/**/*.sh): English only
- CLAUDE.md: English only

**Why**: Command/agent/skill files are code, not user-facing content. They are read by Claude Code (English-based) and must be in English for consistent behavior.

**User-facing vs Internal:**
- User-facing: README, CHANGELOG, documentation (can be localized)
- Internal: Commands, agents, skills, hooks (MUST be English)

### Go-Specific Standards

**File Naming:**
- Go files: `snake_case.go` (e.g., `template_deployer.go`)
- Test files: `snake_case_test.go` (e.g., `settings_test.go`)

**Package Structure:**
```go
// Package doc comment (required for godoc)
// Package template provides template deployment and rendering...
package template

// Exported types have godoc comments
// Deployer extracts and deploys templates from an embedded filesystem...
type Deployer interface { ... }
```

**Error Handling:**
```go
// Always wrap errors with context
if err != nil {
    return fmt.Errorf("deploy templates: %w", err)
}

// Use error wrapping, not string concatenation
return fmt.Errorf("read %q: %w", path, err)  // GOOD
return fmt.Errorf("read " + path + ": " + err.Error())  // BAD
```

### Forbidden
```go
// WRONG - Korean comments
// init 초기화 함수
func init() { ... }

// CORRECT - English comments
// init initializes the CLI commands
func init() { ... }
```

---

## 4. Git Workflow

### Before Commit
- [ ] Code in English
- [ ] Tests passing (`go test ./...`)
- [ ] Linting passing (`golangci-lint run`)
- [ ] Templates regenerated (`make build`)

### Before Push
- [ ] Branch rebased
- [ ] Commits organized
- [ ] Commit messages follow format (Conventional Commits)

### Commit Message Format
```
<type>(<scope>): <description>

[optional body]

[optional footer]
```

**Types:** feat, fix, docs, style, refactor, perf, test, chore, revert

**Examples:**
```
feat(template): add SessionEnd hook to settings.json generator
fix(cli): prevent race condition in hook execution
test(settings): add TestEnsureGlobalSettingsEnv test cases
```

---

## 5. Version Management

### Single Source of Truth

- [HARD] `go.mod` module version + git tags are the authoritative sources
- [HARD] `pkg/version/version.go` reads from git tags at build time

**Version Reference:**
- Authoritative Source: Git tags (e.g., `v1.0.0`)
- Runtime Access: `pkg/version/version.go` via `git describe`
- Config Display: `.moai/config/sections/system.yaml` (updated by release process)

### Build Version Injection

Version is injected at build time using ldflags:

```bash
# Build with version injection
go build -ldflags="-X github.com/modu-ai/moai-adk/pkg/version.Version=v1.0.0"

# Makefile handles this automatically
make build VERSION=1.0.0
```

### Files Requiring Version Sync

When releasing new version, update:

**Documentation Files:**
- README.md (Version line)
- README.ko.md (Version line)
- CHANGELOG.md (New version entry)

**Configuration Files:**
- .moai/config/sections/system.yaml (moai.version)
- internal/template/templates/.moai/config/config.yaml (moai.version)

### Release Process

1. Update CHANGELOG.md with new version entry
2. Create git tag: `git tag v1.0.0`
3. Push tag: `git push origin v1.0.0`
4. Build release binaries: `make release VERSION=1.0.0`

---

## 6. Testing Guidelines

### ⚠️ IMPORTANT: Prevent Accidental File Modifications

When running tests, **always check if they modify project files**.

### Test Execution
```bash
# Run all tests
go test ./...

# Run with race detection
go test -race ./...

# Run with coverage
go test -cover ./...

# Run specific test
go test -run TestEnsureGlobalSettingsEnv ./internal/cli/
```

### Test Isolation

Some tests use `t.TempDir()` for isolation:
```go
func TestSomething(t *testing.T) {
    tempDir := t.TempDir()  // Auto-cleanup after test
    // Work in tempDir instead of project root
}
```

### Coverage Targets

- Package-level: 85% minimum coverage
- Critical packages (cli, template, hook): 90%+ coverage

### Table-Driven Tests (Go Convention)

```go
func TestBuildRequiredPATH(t *testing.T) {
    tests := []struct {
        name    string
        goBin   string
        goPath  string
        want    string
    }{
        {"default", "", "", wantDefault},
        {"custom bin", "/custom/bin", "", wantCustom},
        {"custom path", "", "/custom/path", wantPath},
    }
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Test implementation
        })
    }
}
```

---

## 7. Hook Development Guidelines

### [HARD] Shell Script Hooks Only

moai-adk-go uses shell scripts for hooks, NOT Python:

**Hook Wrapper Pattern:**
```bash
#!/bin/bash
# .claude/hooks/moai/handle-session-start.sh

# Read stdin JSON from Claude Code
INPUT=$(cat)

# Call moai binary with hook subcommand
moai hook session-start <<< "$INPUT"
```

**Why Shell Scripts:**
- Faster execution (no Python startup overhead)
- Always available (no dependency on uv/python)
- Cross-platform (bash, /bin/sh)

### Hook Command Format

**settings.json hook configuration:**
```json
{
  "hooks": {
    "SessionStart": [{
      "hooks": [{
        "command": "\"$CLAUDE_PROJECT_DIR/.claude/hooks/moai/handle-session-start.sh\"",
        "timeout": 5
      }]
    }]
  }
}
```

**Key Rules:**
- [HARD] Always quote `$CLAUDE_PROJECT_DIR`: `"$CLAUDE_PROJECT_DIR"`
- [HARD] Use full path to hook wrapper script
- [HARD] Set appropriate timeout (default: 5 seconds)

### Platform Differences

**macOS/Linux:**
```json
"command": "\"$CLAUDE_PROJECT_DIR/.claude/hooks/moai/hook.sh\""
```

**Windows:**
```json
"command": "\"%CLAUDE_PROJECT_DIR%\\.claude\\hooks\\moai\\hook.sh\""
```

---

## 8. Template Variable Strategy

### Template vs Local Settings

moai-adk-go uses different path variable strategies:

**Template settings** (`internal/template/templates/.claude/settings.json`):
- Uses: `{{.GoBinPath}}` template variable (Go template syntax)
- Purpose: Runtime rendering during `moai init`
- Cross-platform: Resolved by `template.TemplateContext`

**Local settings** (`~/.claude/settings.json`):
- Uses: `"$CLAUDE_PROJECT_DIR"` environment variable
- Purpose: Runtime path resolution by Claude Code
- Cross-platform: Automatically resolved by Claude Code

### Template Variables

Available in Go templates (`*.tmpl` files):

```go
type TemplateContext struct {
    GoBinPath string  // Path to Go bin directory
    HomeDir   string  // User home directory
}
```

**Usage in templates:**
```go
// .moai/status_line.sh.tmpl
export PATH="{{.GoBinPath}}:$PATH"
```

**Rendering:**
```go
ctx := template.NewTemplateContext(
    template.WithGoBinPath(detectGoBinPath()),
    template.WithHomeDir(homeDir),
)
deployer.Deploy(ctx, projectRoot, mgr, ctx)
```

---

## 9. Configuration System

### Config File Format

moai-adk-go uses YAML for configuration:

**Project config** (`.moai/config/config.yaml`):
- Main configuration file
- Contains sections for different settings

**Section files** (`.moai/config/sections/*.yaml`):
- `config.yaml` - Main config
- `quality.yaml` - Quality gates, development mode
- `language.yaml` - Language preferences
- `user.yaml` - User information
- `workflow.yaml` - Workflow settings

### Configuration Priority

1. Environment Variables: `MOAI_USER_NAME`, `MOAI_CONVERSATION_LANG`
2. User Configuration: `.moai/config/sections/*.yaml`
3. Template Defaults: From `internal/template/templates/.moai/config/`

---

## 10. Build and Development Commands

### Common Commands

```bash
# Build the project
make build

# Run tests
make test

# Run with race detection
make test-race

# Run linter
make lint

# Format code
make fmt

# Install locally
make install

# Clean build artifacts
make clean
```

### Development Workflow

```bash
# 1. Edit templates
vim internal/template/templates/.claude/skills/moai/SKILL.md

# 2. Regenerate embedded files
make build

# 3. Run tests
go test ./internal/template/...

# 4. Test locally
./moai init test-project

# 5. Commit
git add internal/template/templates/
git commit -m "feat(template): update SKILL.md"
```

---

## 11. Directory Structure

```
moai-adk-go/
├── cmd/                        # Main application entry points
│   └── moai/                   # CLI command
│       └── main.go             # Entry point
├── internal/                   # Private application code
│   ├── cli/                    # CLI commands
│   │   ├── init.go             # moai init command
│   │   ├── update.go           # moai update command
│   │   └── ...
│   ├── core/                   # Core business logic
│   │   └── project/            # Project management
│   ├── foundation/             # Foundation utilities
│   ├── hook/                   # Hook system
│   ├── manifest/               # Template manifest
│   ├── merge/                  # 3-way merge
│   ├── template/               # Template system
│   │   ├── templates/          # SOURCE: Edit templates here ⭐
│   │   │   ├── .claude/        # Claude Code config templates
│   │   │   │   ├── agents/     # Agent definitions
│   │   │   │   ├── commands/   # Slash commands
│   │   │   │   ├── hooks/      # Hook scripts
│   │   │   │   ├── output-styles/ # Output styles
│   │   │   │   ├── rules/      # Rules
│   │   │   │   └── skills/     # Skill definitions
│   │   │   ├── .moai/          # MoAI config templates
│   │   │   │   └── config/     # Config templates
│   │   │   ├── CLAUDE.md       # Main execution directives
│   │   │   └── *.tmpl          # Template files
│   │   ├── deployer.go         # Template deployment
│   │   ├── renderer.go         # Template rendering
│   │   ├── settings.go         # settings.json generation
│   │   └── embedded.go         # Generated: DO NOT EDIT
│   └── ...
├── pkg/                        # Public libraries
│   ├── models/                 # Data models
│   └── version/                # Version info
├── .claude/                    # Local Claude Code config (NOT in template)
├── .moai/                      # Local MoAI state (NOT in template)
├── CLAUDE.md                   # Synced from templates
├── CLAUDE.local.md             # This file (local only)
├── go.mod                      # Go module definition
├── go.sum                      # Go module checksums
├── Makefile                    # Build commands
└── README.md                   # Project documentation
```

---

## 12. Frequent Issues and Solutions

### Issue: Templates not updated after editing

**Solution:**
```bash
# Regenerate embedded files
make build

# Verify
ls -la internal/template/embedded.go
```

### Issue: Tests modify ~/.claude/settings.json

**Solution:** Tests should use `t.TempDir()` for isolation. Check if test creates files in project root.

### Issue: Hook timeout

**Solution:** Increase timeout in settings.json:
```json
{"timeout": 60}  # 60 seconds instead of default 5
```

---

## 13. Important Notes

- `/Users/goos/MoAI/moai-adk-go/.claude/` is for local development only
- Template changes require `make build` to regenerate embedded files
- `.moai/project/` and `.moai/specs/` are protected from deletion
- All code must be in English (comments, godoc, variables)
- Use `golangci-lint` for linting before commits
- Run `go test -race ./...` to detect race conditions

---

## 14. Reference

- CLAUDE.md: Alfred execution directives
- README.md: Project overview
- Skill("moai-foundation-core"): Execution rules
- Skill("moai-foundation-claude"): Plugin development, sandboxing
- Go Code Review Comments: https://github.com/golang/go/wiki/CodeReviewComments
- Effective Go: https://go.dev/doc/effective_go

---

**Status**: Active (Local Development)
**Version**: 1.0.0 (Initial version for moai-adk-go)
**Last Updated**: 2026-02-06
